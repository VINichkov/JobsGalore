
//= require jquery.min.js
//= require jquery_ujs
//= require bootstrap.min
//= require bootstrap-datepicker
//= require bootstrap-typeahead
//= require social-share-button
//=require jasny-bootstrap
//=require datalist-polyfill.min
//= require react
//= require components
//= require react_ujs
//= /require tinymce
//=require html-formatting.js

var uploadTXT = function(uploadFile,tiny_id) {
    let ed = tinymce.get(tiny_id);
    ed.setProgressState(1); // Show progress
    let reader = new FileReader();
    reader.onload = function (e) {
        let html = e.target.result;
        html = html.replace(new RegExp('<','g'), "&lt;");
        html = html.replace(new RegExp('>','g'), "&gt;");
        window.setTimeout(function() {
            ed.setContent(html, { format: 'html' });
            ed.setProgressState(0); // Hide progress
        }, 3000);
    };
    reader.readAsText(uploadFile);
};

var uploadPdfDocx = function(uploadFile,tiny_id) {
    let ed = tinymce.get(tiny_id);
    ed.setProgressState(1);
    let fd = new FormData;
    fd.append('file', uploadFile);
    ed.setProgressState(1);
    $.ajax({
        type: 'POST',
        url: "<%=Rails.application.routes.url_helpers.file_to_html_path%>",
        data: fd,
        success: function( data ) {
            // Show progress
            window.setTimeout(function() {
                ed.setContent(data.description, { format: 'html' });
                ed.setProgressState(0); // Hide progress
            }, 3000);
        },
        contentType: false,
        processData: false
    });
};

var readURL = function (input, tiny_id) {
    if (input.files) {
        let uploadFile = input.files[0];
        switch(uploadFile.type){
            case 'text/plain':
                uploadTXT(uploadFile,tiny_id);
                break;
            default:
                uploadPdfDocx(uploadFile,tiny_id);
        }
    }
}

var tinyValidElements={
    'h1,h2,h3,h4,h5,h6,p,ul,li,strong,pre,code,b,span,div': {
        valid_styles: 'text-align,color',
        valid_classes: '',
        valid_attributes: 'style, href, color'
    },
    'form': {
        valid_styles: null,
        valid_classes: null,
        valid_attributes: 'color'
    }
};
var tinyEditorOptions={
    selector: "textarea",
    plugins: "paste lists",
    branding: false,
    toolbar: 'formatselect | bold italic underline backcolor | alignleft aligncenter alignright | numlist bullist outdent indent  | removeformat ',
    image_advtab: true,
    menubar: null,
    block_formats: 'Paragraph=p; Heading 3=h3; Heading 4=h4;',
    paste_preprocess: function(plugin, args) {
        console.log(args.content);
    },
    theme_advanced_buttons3_add : "pastetext,pasteword,selectall",
    paste_postprocess: function (plugin, args) {
        console.log(args);
        htmlFormatting(args.node, tinyValidElements);
    }
};

$(function() {
        var states = ['Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California',
            'Colorado', 'Connecticut', 'Delaware', 'Florida', 'Georgia', 'Hawaii',
            'Idaho', 'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana',
            'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota',
            'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire',
            'New Jersey', 'New Mexico', 'New York', 'North Carolina', 'North Dakota',
            'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania', 'Rhode Island',
            'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont',
            'Virginia', 'Washington', 'West Virginia', 'Wisconsin', 'Wyoming'
        ];


        $('#city').typeahead({
            source: states
        });

    $('.datepicker_reg').datepicker({
        orientation: "bottom auto",
        language: "en-AU",
        autoclose: true
    });

});